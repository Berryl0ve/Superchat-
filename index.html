<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Student Chat</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
    
    .container { width: 100%; max-width: 500px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 80vh; overflow: hidden; }
    
    /* Auth Screen */
    #auth-screen { display: flex; flex-direction: column; padding: 40px; text-align: center; margin-top: 10%; }
    #auth-screen input { padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    .auth-btn-row { display: flex; gap: 10px; margin-top: 10px; }
    .auth-btn-row button { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; }
    #login-btn { background: #0084ff; }
    #signup-btn { background: #333; }
    #auth-error { color: red; font-size: 13px; margin-top: 15px; }
    
    /* Chat Screen */
    #chat-screen { display: none; flex-direction: column; height: 100%; }
    
    /* Top Bar */
    #top-bar { background: #0084ff; color: white; padding: 15px; display: flex; gap: 10px; align-items: center; }
    #top-bar input { flex-grow: 1; padding: 8px; border-radius: 5px; border: none; outline: none; }
    #start-chat-btn { padding: 8px 15px; background: white; color: #0084ff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #logout-btn { padding: 8px 10px; background: #ff3b30; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    
    /* Messages */
    #messages { flex-grow: 1; padding: 20px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; }
    .message { margin-bottom: 10px; padding: 10px 15px; border-radius: 15px; width: fit-content; max-width: 75%; word-wrap: break-word; }
    .sent { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    .received { background: #e4e6eb; color: black; align-self: flex-start; border-bottom-left-radius: 2px; }
    .sender-name { font-size: 11px; margin-bottom: 3px; opacity: 0.7; }

    /* Input Box */
    #input-area { display: flex; padding: 15px; background: #f0f2f5; border-top: 1px solid #ddd; }
    #message-input { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
    #send-btn { padding: 10px 20px; margin-left: 10px; background: #0084ff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
    #send-btn:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

  <div class="container">
    
    <div id="auth-screen">
      <h2>Webex Lite Security</h2>
      <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Sign up with an email to lock your username.</p>
      
      <input type="email" id="email-input" placeholder="Email (e.g., jack@school.edu)">
      <input type="password" id="password-input" placeholder="Password (at least 6 chars)">
      
      <div class="auth-btn-row">
        <button id="login-btn">Log In</button>
        <button id="signup-btn">Sign Up</button>
      </div>
      <p id="auth-error"></p>
    </div>

    <div id="chat-screen">
      <div id="top-bar">
        <span>To:</span>
        <input type="text" id="friend-username" placeholder="Friend's name (e.g., jack)">
        <button id="start-chat-btn">Chat</button>
        <button id="logout-btn">Exit</button>
      </div>
      
      <div id="messages"></div>
      
      <div id="input-area">
        <input type="text" id="message-input" placeholder="Type a message..." disabled>
        <button id="send-btn" disabled>Send</button>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
    
    // NEW: We imported the Authentication tools!
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <-- ADD THIS LINE
      databaseURL: "https://superchat-2f8ba-default-rtdb.firebaseio.com",
      projectId: "superchat-2f8ba",
      storageBucket: "superchat-2f8ba.firebasestorage.app",
      messagingSenderId: "484473938445",
      appId: "1:484473938445:web:8a5ce451600707b8bdeb44"
    };


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app); // Starts the security engine

    let myName = "";
    let friendName = "";
    let currentRoomRef = null;

    // UI Elements
    const authScreen = document.getElementById("auth-screen");
    const chatScreen = document.getElementById("chat-screen");
    const emailInput = document.getElementById("email-input");
    const passwordInput = document.getElementById("password-input");
    const authError = document.getElementById("auth-error");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");

    // --- 1. SIGN UP LOGIC ---
    document.getElementById("signup-btn").addEventListener("click", () => {
      createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value)
        .catch(error => { authError.innerText = error.message; }); // Shows error if password is too short, etc.
    });

    // --- 2. LOG IN LOGIC ---
    document.getElementById("login-btn").addEventListener("click", () => {
      signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value)
        .catch(error => { authError.innerText = "Invalid email or password."; });
    });

    // --- 3. LOG OUT LOGIC ---
    document.getElementById("logout-btn").addEventListener("click", () => {
      signOut(auth);
    });

    // --- 4. THE MAGIC WATCHER ---
    // This constantly checks if the user is successfully logged in or logged out
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is IN!
        authScreen.style.display = "none";
        chatScreen.style.display = "flex";
        
        // Grab the part before the '@' symbol to be their username
        myName = user.email.split('@')[0].toLowerCase();
        
        // Clear out the auth text boxes for security
        emailInput.value = "";
        passwordInput.value = "";
        authError.innerText = "";
      } else {
        // User is OUT!
        authScreen.style.display = "flex";
        chatScreen.style.display = "none";
        
        // Reset the chat so the next person doesn't see old messages
        messagesDiv.innerHTML = ""; 
        currentRoomRef = null;
        messageInput.disabled = true;
        sendBtn.disabled = true;
      }
    });

    // --- 5. OPEN CHAT LOGIC ---
    document.getElementById("start-chat-btn").addEventListener("click", () => {
      friendName = document.getElementById("friend-username").value.trim().toLowerCase();
      
      if (friendName !== "") {
        messagesDiv.innerHTML = ""; 
        messageInput.disabled = false; 
        sendBtn.disabled = false; 
        
        const roomName = [myName, friendName].sort().join('_');
        currentRoomRef = ref(db, "direct_messages/" + roomName);

        onChildAdded(currentRoomRef, (snapshot) => {
          const messageData = snapshot.val();
          const msgDiv = document.createElement("div");
          msgDiv.classList.add("message");
          
          if (messageData.sender === myName) {
            msgDiv.classList.add("sent");
            msgDiv.innerText = messageData.text;
          } else {
            msgDiv.classList.add("received");
            msgDiv.innerHTML = `<div class='sender-name'>${messageData.sender}</div>${messageData.text}`;
          }
          
          messagesDiv.appendChild(msgDiv);
          messagesDiv.scrollTop = messagesDiv.scrollHeight; 
        });
      }
    });

    // --- 6. SEND MESSAGE LOGIC ---
    sendBtn.addEventListener("click", () => {
      const text = messageInput.value;
      if (text.trim() !== "" && currentRoomRef !== null) {
        push(currentRoomRef, { sender: myName, text: text }); 
        messageInput.value = ""; 
      }
    });

    messageInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") { sendBtn.click(); }
    });
  </script>
</body>
</html>
